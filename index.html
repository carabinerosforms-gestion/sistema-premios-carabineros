<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Postulaci√≥n a Premios - Carabineros de Chile</title>
    <style>
        /* ===== PALETA OFICIAL CARABINEROS DE CHILE ===== */
        :root {
            --azul-carabineros: #0033a0;       /* Azul oficial */
            --rojo-carabineros: #d52b1e;       /* Rojo oficial */
            --dorado-carabineros: #c9a35c;     /* Dorado de insignias */
            --gris-oscuro: #2c3e50;            /* Uniforme de gala */
            --gris-medio: #5d6d7e;             /* Uniforme diario */
            --blanco: #ffffff;
            --gris-claro: #f8f9fa;
            --verde-ok: #27ae60;
            --rojo-error: #e74c3c;
            --amarillo-alerta: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--gris-oscuro);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--blanco);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 51, 160, 0.15);
            overflow: hidden;
            border: 1px solid rgba(0, 51, 160, 0.1);
        }
        
        /* ===== HEADER CON COLORES INSTITUCIONALES ===== */
        header {
            background: linear-gradient(135deg, var(--azul-carabineros) 0%, #0048d0 100%);
            color: var(--blanco);
            padding: 25px 30px;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 150px;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, var(--rojo-carabineros) 100%);
            clip-path: polygon(100% 0, 100% 100%, 0 100%);
        }
        
        .logo-institucional {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .escudo-container {
            width: 70px;
            height: 70px;
            background: var(--blanco);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--dorado-carabineros);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .escudo {
            font-size: 2rem;
            font-weight: bold;
            color: var(--azul-carabineros);
            background: linear-gradient(45deg, var(--azul-carabineros), var(--rojo-carabineros));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .titulo-principal h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .titulo-principal .subtitulo {
            font-size: 1rem;
            opacity: 0.95;
            font-weight: 300;
        }
        
        /* ===== BARRA DE PROGRESO MEJORADA ===== */
        .progress-bar {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            padding: 0;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 15px 5px;
            position: relative;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            cursor: default;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .step:last-child {
            border-right: none;
        }
        
        .step.active {
            color: var(--blanco);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .step.active .step-number {
            background: var(--dorado-carabineros);
            color: var(--azul-carabineros);
            border-color: var(--blanco);
        }
        
        .step.completed {
            color: var(--blanco);
        }
        
        .step.completed .step-number {
            background: var(--verde-ok);
            color: var(--blanco);
        }
        
        .step-number {
            display: inline-block;
            width: 28px;
            height: 28px;
            line-height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: var(--blanco);
            margin-right: 8px;
            border: 2px solid transparent;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        /* ===== CONTENIDO PRINCIPAL ===== */
        .main-content {
            padding: 30px;
            min-height: 500px;
        }
        
        .step-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }
        
        .step-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== SECCIONES DE FORMULARIO ===== */
        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            background: var(--gris-claro);
            border-radius: 10px;
            border-left: 5px solid var(--azul-carabineros);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .form-section h3 {
            color: var(--azul-carabineros);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0, 51, 160, 0.1);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-section h3::before {
            content: 'üìã';
            font-size: 1.2rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--gris-oscuro);
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .form-group label .required {
            color: var(--rojo-carabineros);
            margin-left: 3px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
            background: var(--blanco);
        }
        
        .form-control:focus {
            border-color: var(--azul-carabineros);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 51, 160, 0.1);
        }
        
        .form-control.error {
            border-color: var(--rojo-error);
            background: #fff5f5;
        }
        
        .form-control.success {
            border-color: var(--verde-ok);
        }
        
        .error-message {
            color: var(--rojo-error);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
            font-weight: 500;
        }
        
        .error-message.show {
            display: block;
            animation: shake 0.3s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* ===== BOTONES CON COLORES INSTITUCIONALES ===== */
        .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid rgba(0, 51, 160, 0.1);
        }
        
        .btn {
            padding: 12px 35px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 150px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--azul-carabineros) 0%, #0048d0 100%);
            color: var(--blanco);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0048d0 0%, #0033a0 100%);
        }
        
        .btn-secondary {
            background: var(--gris-medio);
            color: var(--blanco);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--verde-ok) 0%, #219653 100%);
            color: var(--blanco);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--rojo-error) 0%, #c0392b 100%);
            color: var(--blanco);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* ===== REQUISITOS Y VALIDACIONES ===== */
        .requisitos-box {
            background: linear-gradient(135deg, #e8f4ff 0%, #d4e7ff 100%);
            border: 2px solid var(--azul-carabineros);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .requisitos-box h4 {
            color: var(--azul-carabineros);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .requisitos-box h4::before {
            content: '‚úÖ';
        }
        
        .requisitos-box ul {
            list-style: none;
            padding-left: 0;
        }
        
        .requisitos-box li {
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
            color: var(--gris-oscuro);
        }
        
        .requisitos-box li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: var(--verde-ok);
            font-weight: bold;
        }
        
        /* ===== TABLAS Y RESUMEN ===== */
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--blanco);
        }
        
        th {
            background: linear-gradient(135deg, var(--azul-carabineros) 0%, #0048d0 100%);
            color: var(--blanco);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 3px solid var(--dorado-carabineros);
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            color: var(--gris-oscuro);
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        /* ===== BADGES DE ESTADO ===== */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-complete {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* ===== MODAL DE CONFIRMACI√ìN ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--blanco);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-top: 5px solid var(--azul-carabineros);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0, 51, 160, 0.1);
        }
        
        .modal-header h3 {
            color: var(--azul-carabineros);
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gris-medio);
            line-height: 1;
        }
        
        /* ===== ALERTAS Y NOTIFICACIONES ===== */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .hidden {
            display: none;
        }
        
        .form-help {
            font-size: 0.85rem;
            color: var(--gris-medio);
            margin-top: 5px;
            font-style: italic;
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 8px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .progress-bar {
                flex-direction: column;
            }
            
            .step {
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            }
            
            .step:last-child {
                border-bottom: none;
            }
            
            header {
                padding: 20px;
            }
            
            .titulo-principal h1 {
                font-size: 1.5rem;
            }
        }
        
        /* ===== ANIMACIONES ADICIONALES ===== */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 51, 160, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 51, 160, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 51, 160, 0); }
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        /* ===== LOADING SPINNER ===== */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--azul-carabineros);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER CON COLORES OFICIALES -->
        <header>
            <div class="logo-institucional">
                <div class="escudo-container">
                    <div class="escudo">C</div>
                </div>
                <div class="titulo-principal">
                    <h1>SISTEMA DE POSTULACI√ìN A PREMIOS</h1>
                    <div class="subtitulo">Carabineros de Chile - Orden General N¬∞ 3125/2024</div>
                </div>
            </div>
            
            <!-- BARRA DE PROGRESO MEJORADA -->
            <div class="progress-bar">
                <div class="step" id="step1">
                    <span class="step-number">1</span> Categor√≠a
                </div>
                <div class="step" id="step2">
                    <span class="step-number">2</span> Datos
                </div>
                <div class="step" id="step3">
                    <span class="step-number">3</span> Antecedentes
                </div>
                <div class="step" id="step4">
                    <span class="step-number">4</span> Evaluaci√≥n
                </div>
                <div class="step" id="step5">
                    <span class="step-number">5</span> Revisi√≥n
                </div>
            </div>
        </header>
        
        <!-- CONTENIDO PRINCIPAL -->
        <div class="main-content">
            <!-- ALERTA GLOBAL -->
            <div class="alert" id="globalAlert"></div>
            
            <!-- PASO 1: SELECCI√ìN DE CATEGOR√çA -->
            <div class="step-content active" id="stepContent1">
                <div class="form-section">
                    <h3>Selecci√≥n de Categor√≠a de Premio</h3>
                    <p>Seleccione la categor√≠a para la cual postula el funcionario, conforme al Manual OG 3125:</p>
                    
                    <div class="form-group">
                        <label>Categor√≠a de Premio <span class="required">*</span></label>
                        <select id="categoriaPremio" class="form-control">
                            <option value="">-- Seleccione categor√≠a --</option>
                            <option value="d1">d.1 - Desempe√±o Profesional Operativo</option>
                            <option value="d2">d.2 - Servicios Destacados a la Comunidad</option>
                            <option value="d3">d.3 - Acci√≥n Policial Destacada</option>
                            <option value="d4">d.4 - Acciones Destacadas en DD.HH.</option>
                            <option value="f1">f.1 - Desempe√±o Profesional Administrativo</option>
                        </select>
                        <div class="error-message" id="categoriaError">Debe seleccionar una categor√≠a de premio</div>
                        <div class="form-help">Consulte el Manual OG 3125 para verificar requisitos espec√≠ficos</div>
                    </div>
                    
                    <!-- REQUISITOS ESPEC√çFICOS DE LA CATEGOR√çA -->
                    <div id="requisitosCategoria" class="requisitos-box hidden">
                        <h4>Requisitos espec√≠ficos de la categor√≠a seleccionada:</h4>
                        <ul id="listaRequisitos"></ul>
                    </div>
                </div>
                
                <!-- BOTONES DE NAVEGACI√ìN -->
                <div class="btn-group">
                    <button class="btn btn-secondary" disabled onclick="prevStep(0)">
                        ‚Üê Anterior
                    </button>
                    <button class="btn btn-primary" onclick="nextStep(2)" id="btnNextStep1">
                        Siguiente ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- PASO 2: DATOS PERSONALES -->
            <div class="step-content" id="stepContent2">
                <div class="form-section">
                    <h3>Datos del Funcionario</h3>
                    <div class="form-grid">
                        <!-- RUN -->
                        <div class="form-group">
                            <label>RUN <span class="required">*</span></label>
                            <input type="text" id="run" class="form-control" placeholder="12.345.678-9" 
                                   oninput="formatearRUNCampo(this)" onblur="validarRUNCampo()">
                            <div class="error-message" id="runError">RUN inv√°lido. Formato: 12.345.678-9</div>
                        </div>
                        
                        <!-- NOMBRES -->
                        <div class="form-group">
                            <label>Nombres <span class="required">*</span></label>
                            <input type="text" id="nombres" class="form-control" placeholder="JUAN CARLOS" 
                                   oninput="this.value = this.value.toUpperCase()">
                            <div class="error-message" id="nombresError">Debe ingresar los nombres</div>
                        </div>
                        
                        <!-- APELLIDOS -->
                        <div class="form-group">
                            <label>Apellidos <span class="required">*</span></label>
                            <input type="text" id="apellidos" class="form-control" placeholder="P√âREZ GONZ√ÅLEZ" 
                                   oninput="this.value = this.value.toUpperCase()">
                            <div class="error-message" id="apellidosError">Debe ingresar los apellidos</div>
                        </div>
                        
                        <!-- NOMBRAMIENTO -->
                        <div class="form-group">
                            <label>Nombramiento <span class="required">*</span></label>
                            <select id="nombramiento" class="form-control">
                                <option value="">-- Seleccione --</option>
                                <option value="PNS">P.N.S. (Personal de Nombramiento Supremo)</option>
                                <option value="PNI">P.N.I. (Personal de Nombramiento Institucional)</option>
                                <option value="CPR">C.P.R. (Contratado por Resoluci√≥n)</option>
                            </select>
                            <div class="error-message" id="nombramientoError">Seleccione el tipo de nombramiento</div>
                        </div>
                        
                        <!-- GRADO -->
                        <div class="form-group">
                            <label>Grado <span class="required">*</span></label>
                            <select id="grado" class="form-control" disabled>
                                <option value="">-- Seleccione nombramiento primero --</option>
                            </select>
                            <div class="error-message" id="gradoError">Seleccione el grado correspondiente</div>
                        </div>
                        
                        <!-- ALTA REPARTICI√ìN -->
                        <div class="form-group">
                            <label>Alta Repartici√≥n <span class="required">*</span></label>
                            <input type="text" id="altaReparticion" class="form-control" 
                                   placeholder="Ej: Zona Metropolitana">
                            <div class="error-message" id="altaRepError">Debe ingresar la Alta Repartici√≥n</div>
                        </div>
                        
                        <!-- REPARTICI√ìN -->
                        <div class="form-group">
                            <label>Repartici√≥n <span class="required">*</span></label>
                            <input type="text" id="reparticion" class="form-control" 
                                   placeholder="Ej: Prefectura Norte">
                            <div class="error-message" id="reparticionError">Debe ingresar la Repartici√≥n</div>
                        </div>
                        
                        <!-- DOTACI√ìN -->
                        <div class="form-group">
                            <label>Dotaci√≥n <span class="required">*</span></label>
                            <input type="text" id="dotacion" class="form-control" 
                                   placeholder="Ej: 6¬™ Comisar√≠a 'Recoleta'">
                            <div class="error-message" id="dotacionError">Debe ingresar la Dotaci√≥n</div>
                        </div>
                    </div>
                </div>
                
                <!-- BOTONES DE NAVEGACI√ìN -->
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep(1)">
                        ‚Üê Anterior
                    </button>
                    <button class="btn btn-primary" onclick="nextStep(3)" id="btnNextStep2">
                        Siguiente ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- PASO 3: ANTECEDENTES ADMINISTRATIVOS -->
            <div class="step-content" id="stepContent3">
                <div class="form-section">
                    <h3>Antecedentes Administrativos y Disciplinarios</h3>
                    <p>Complete la informaci√≥n seg√∫n los registros institucionales (Art√≠culo 8.7 OG 3125)</p>
                    
                    <div class="form-grid">
                        <!-- LISTA DE M√âRITOS -->
                        <div class="form-group">
                            <label>¬øEn Lista N¬∞1 de M√©ritos o N¬∞2 Satisfactorios? <span class="required">*</span></label>
                            <select id="listaMeritos" class="form-control">
                                <option value="">-- Seleccione --</option>
                                <option value="lista1">Lista N¬∞1 - M√©ritos</option>
                                <option value="lista2">Lista N¬∞2 - Satisfactorios</option>
                                <option value="ninguna">No est√° en ninguna lista</option>
                            </select>
                            <div class="error-message" id="listaError">Selecci√≥n requerida seg√∫n OG 3125</div>
                        </div>
                        
                        <!-- SANCIONES √öLTIMOS 12 MESES -->
                        <div class="form-group">
                            <label>¬øTiene sanciones (d√≠as de arresto) √∫ltimos 12 meses? <span class="required">*</span></label>
                            <select id="sanciones12meses" class="form-control" onchange="validarElegibilidad()">
                                <option value="">-- Seleccione --</option>
                                <option value="no">No</option>
                                <option value="si">S√≠</option>
                            </select>
                            <div class="error-message" id="sancionesError">Selecci√≥n requerida</div>
                        </div>
                        
                        <!-- PROCESO JUDICIAL -->
                        <div class="form-group">
                            <label>¬øSometido a proceso judicial? <span class="required">*</span></label>
                            <select id="procesoJudicial" class="form-control" onchange="validarElegibilidad()">
                                <option value="">-- Seleccione --</option>
                                <option value="no">No</option>
                                <option value="si_imputado">S√≠ - Formalizado/Imputado</option>
                                <option value="si_victima">S√≠ - En calidad de v√≠ctima/testigo</option>
                            </select>
                            <div class="error-message" id="procesoError">Selecci√≥n requerida</div>
                        </div>
                    </div>
                    
                    <!-- HISTORIAL DISCIPLINARIO -->
                    <h4 style="margin: 30px 0 15px 0; color: var(--azul-carabineros); padding-bottom: 10px; border-bottom: 1px solid #eee;">
                        Historial Disciplinario (trayectoria)
                    </h4>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Amonestaciones</label>
                            <input type="number" id="amonestaciones" class="form-control" min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label>Reprensiones</label>
                            <input type="number" id="reprensiones" class="form-control" min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label>Arrestos</label>
                            <input type="number" id="arrestos" class="form-control" min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label>D√≠as licencia acto del servicio</label>
                            <input type="number" id="licenciaActo" class="form-control" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- BOTONES DE NAVEGACI√ìN -->
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep(2)">
                        ‚Üê Anterior
                    </button>
                    <button class="btn btn-primary" onclick="nextStep(4)" id="btnNextStep3">
                        Siguiente ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- PASO 4: EVALUACI√ìN -->
            <div class="step-content" id="stepContent4">
                <div class="form-section">
                    <h3>Evaluaci√≥n de Factores - <span id="categoriaTitulo"></span></h3>
                    <p>Califique cada factor seg√∫n la escala establecida en el Manual OG 3125:</p>
                    
                    <div class="requisitos-box">
                        <h4>Escala de evaluaci√≥n:</h4>
                        <ul>
                            <li><strong>3 - Excelente:</strong> Desempe√±o √≥ptimo, exento de faltas importantes</li>
                            <li><strong>2 - Muy Bueno:</strong> Desempe√±o por sobre lo esperado</li>
                            <li><strong>1 - Bueno:</strong> Desempe√±o con aportes esperados</li>
                        </ul>
                        <p style="margin-top: 10px; color: var(--rojo-carabineros); font-weight: bold;">
                            * Puntaje 3 requiere justificaci√≥n obligatoria
                        </p>
                    </div>
                    
                    <!-- FACTORES DIN√ÅMICOS -->
                    <div id="factoresEvaluacion"></div>
                    
                    <!-- SECCI√ìN ESPECIAL PARA ACCI√ìN POLICIAL -->
                    <div id="seccionAccionPolicial" class="hidden">
                        <div class="form-group">
                            <label>Narraci√≥n del hecho destacado <span class="required">*</span></label>
                            <textarea id="narracionHecho" class="form-control" rows="4" 
                                      placeholder="Describa brevemente la acci√≥n policial destacada, indicando fecha, lugar, circunstancias y participantes..."></textarea>
                            <div class="error-message" id="narracionError">Debe describir la acci√≥n policial destacada</div>
                        </div>
                        
                        <div class="form-group">
                            <label>Razones que fundamentan la proposici√≥n <span class="required">*</span></label>
                            <textarea id="razonesFundamentacion" class="form-control" rows="4" 
                                      placeholder="Explique las razones para proponer esta acci√≥n, considerando impacto, riesgo asumido, resultados obtenidos..."></textarea>
                            <div class="error-message" id="razonesError">Debe proporcionar las razones de fundamentaci√≥n</div>
                        </div>
                    </div>
                    
                    <!-- TOTAL PUNTAJE -->
                    <div class="form-group" style="margin-top: 30px;">
                        <label>Total Puntaje Obtenido:</label>
                        <input type="text" id="totalPuntaje" class="form-control" style="font-size: 1.2rem; font-weight: bold; text-align: center;" 
                               readonly value="0">
                        <div class="form-help">Suma de todos los factores evaluados</div>
                    </div>
                </div>
                
                <!-- BOTONES DE NAVEGACI√ìN -->
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep(3)">
                        ‚Üê Anterior
                    </button>
                    <button class="btn btn-primary" onclick="nextStep(5)" id="btnNextStep4">
                        Siguiente ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- PASO 5: REVISI√ìN FINAL -->
            <div class="step-content" id="stepContent5">
                <div class="form-section">
                    <h3>Revisi√≥n Final de la Postulaci√≥n</h3>
                    
                    <!-- ALERTA DE VALIDACI√ìN -->
                    <div class="alert" id="revisionAlert"></div>
                    
                    <!-- RESUMEN DE POSTULACI√ìN -->
                    <div id="resumenPostulacion"></div>
                    
                    <!-- VALIDACI√ìN OG 3125 -->
                    <div class="requisitos-box">
                        <h4>Validaci√≥n conforme a Orden General N¬∞ 3125</h4>
                        <ul id="validacionLista">
                            <li id="valCategoria">‚úì Categor√≠a seleccionada correctamente</li>
                            <li id="valDatos">‚úì Datos personales completos y v√°lidos</li>
                            <li id="valAntecedentes">‚úì Antecedentes validados seg√∫n Art. 8.7</li>
                            <li id="valEvaluacion">‚úì Evaluaci√≥n completa con justificaciones</li>
                            <li id="valElegibilidad">‚úì Cumple requisitos de elegibilidad</li>
                            <li id="valSheets">‚è≥ Conexi√≥n con Google Sheets</li>
                        </ul>
                    </div>
                    
                    <!-- FIRMA DEL PROPONENTE -->
                    <div style="margin-top: 30px; padding: 20px; border: 2px dashed #ddd; border-radius: 8px;">
                        <h4 style="color: var(--azul-carabineros); margin-bottom: 15px;">Declaraci√≥n del Proponente</h4>
                        <p style="margin-bottom: 15px; color: var(--gris-oscuro);">
                            <input type="checkbox" id="declaracionVeracidad" style="margin-right: 10px;">
                            <label for="declaracionVeracidad" style="font-weight: 600;">
                                Declaro bajo juramento que la informaci√≥n proporcionada en esta postulaci√≥n es veraz, 
                                completa y ajustada a los requisitos establecidos en la Orden General N¬∞ 3125 de Carabineros de Chile.
                            </label>
                        </p>
                        <div class="error-message" id="declaracionError" style="margin-top: 10px;">
                            Debe aceptar la declaraci√≥n de veracidad
                        </div>
                    </div>
                </div>
                
                <!-- BOTONES FINALES -->
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep(4)">
                        ‚Üê Anterior
                    </button>
                    <button class="btn btn-success" onclick="enviarPostulacion()" id="btnEnviar" disabled>
                        ‚úÖ Enviar Postulaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE CONFIRMACI√ìN -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úÖ Postulaci√≥n Enviada Exitosamente</h3>
                <button class="close-modal" onclick="closeModal()">√ó</button>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <div style="font-size: 4rem; color: var(--verde-ok); margin-bottom: 10px;">‚úì</div>
                <h4 style="color: var(--azul-carabineros); margin-bottom: 15px;">Postulaci√≥n Registrada</h4>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p><strong>ID de Postulaci√≥n:</strong> <span id="postulacionId" style="font-weight: bold; color: var(--azul-carabineros);"></span></p>
                <p><strong>Fecha y Hora:</strong> <span id="postulacionFecha"></span></p>
                <p><strong>Estado:</strong> <span class="status-badge status-complete">COMPLETA CONFORME OG 3125</span></p>
                <p><strong>Google Sheets:</strong> <span id="sheetsStatus" class="status-badge status-complete">REGISTRADO</span></p>
            </div>
            
            <p style="margin-bottom: 20px; color: var(--gris-oscuro);">
                La postulaci√≥n ha sido registrada en el sistema y se encuentra disponible para revisi√≥n 
                por la autoridad competente seg√∫n el proceso establecido en la Orden General N¬∞ 3125.
            </p>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="nuevaPostulacion()">
                    üìù Nueva Postulaci√≥n
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ===== CONFIGURACI√ìN GOOGLE SHEETS =====
        const GOOGLE_SHEETS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzAslvlJEuoVZQ2sY9ipH7Ei6vD5gFQgyngP7g4uJc3Dtkb0jyEdYh8F-Sa-ZsL0p0j_A/exec';
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1nu_IdO43-zRTVQF06CXydpG0PnbcGShBobXLvoRF_0w/edit?usp=sharing';
        
        // ===== DATOS DEL SISTEMA (CORREGIDOS) =====
        const sistema = {
            categorias: {
                d1: {
                    nombre: "Desempe√±o Profesional Operativo",
                    requisitos: [
                        "Personal de Nombramiento Supremo (Subteniente a Teniente Coronel)",
                        "Personal de Nombramiento Institucional (Carabinero a Suboficial Mayor)",
                        "Lista N¬∞1 de M√©ritos o N¬∞2 Satisfactorios",
                        "Sin sanciones √∫ltimos 12 meses (d√≠as de arresto)",
                        "Sin procesos judiciales como imputado"
                    ],
                    factores: [
                        "Eficacia: Realiza trabajos seg√∫n objetivos y metas asignadas",
                        "Eficiencia: Administra recursos con m√°ximo rendimiento",
                        "Calidad de trabajo: Cumple labor sin errores importantes",
                        "Capacidad de Gesti√≥n: Anticipa necesidades y genera acciones proactivas",
                        "Servicios a la comunidad: Interact√∫a permanentemente con ciudadan√≠a",
                        "Motivaci√≥n laboral: Buena disposici√≥n en cumplimiento de obligaciones",
                        "Iniciativa: Propone soluciones sin necesidad de supervisi√≥n",
                        "Relaciones interpersonales: Trato amable y respetuoso",
                        "Discreci√≥n: Reserva en manejo de informaci√≥n institucional",
                        "Principios y Valores: Comportamiento √©tico acorde a la Instituci√≥n"
                    ],
                    puntajeMinimo: 10
                },
                d2: {
                    nombre: "Servicios Destacados a la Comunidad",
                    requisitos: [
                        "Personal de Nombramiento Supremo o Institucional",
                        "Desempe√±o √≥ptimo en acercamiento a la comunidad",
                        "Lista N¬∞1 de M√©ritos o N¬∞2 Satisfactorios",
                        "Sin procesos judiciales como imputado",
                        "Aprobaci√≥n del Jefe de Zona o Prefecto"
                    ],
                    factores: [
                        "Desempe√±o Comunitario: Detecta necesidades ciudadanas",
                        "Capacidad para solucionar problemas",
                        "Integraci√≥n Social: Mantiene canales de comunicaci√≥n",
                        "Calidad de Servicio: Cumple con orientaci√≥n de compromiso comunitario",
                        "Aporte a la efectividad Institucional",
                        "Liderazgo social: Motiva a la comunidad",
                        "Inter√©s por el trabajo hacia la comunidad",
                        "Relaciones interpersonales respetuosas",
                        "Iniciativa en soluciones comunitarias",
                        "Principios y Valores institucionales"
                    ],
                    puntajeMinimo: 10
                },
                d3: {
                    nombre: "Acci√≥n Policial Destacada",
                    requisitos: [
                        "Hecho de importancia, gravedad o trascendencia",
                        "Impacto positivo en la comunidad",
                        "Personal puso en riesgo su integridad f√≠sica",
                        "Evit√≥ que personal o civiles resultaran afectados",
                        "Acci√≥n prestigia a Carabineros de Chile",
                        "Excede exigencias normales del servicio"
                    ],
                    factores: [
                        "Importancia y trascendencia del hecho",
                        "Impacto en la comunidad",
                        "Participaci√≥n activa del personal",
                        "Nivel de riesgo para la integridad f√≠sica",
                        "Protecci√≥n a personal institucional y civiles",
                        "Prestigio institucional generado",
                        "Exceder exigencias del servicio",
                        "Grado de compromiso demostrado",
                        "Reconocimiento requerido",
                        "Caracter√≠sticas distintivas sobre lo exigido"
                    ],
                    puntajeMinimo: 8
                },
                d4: {
                    nombre: "Acciones Destacadas en Promoci√≥n de DD.HH.",
                    requisitos: [
                        "Personal que propone iniciativas para garantizar DD.HH.",
                        "Evidencia compromiso institucional con est√°ndares nacionales e internacionales",
                        "Lista N¬∞1 de M√©ritos o N¬∞2 Satisfactorios",
                        "Sin sanciones graves",
                        "Aprobaci√≥n de la Secci√≥n de DD.HH."
                    ],
                    factores: [
                        "Eficacia en procedimientos de DD.HH.",
                        "Eficiencia en uso de recursos para DD.HH.",
                        "Contribuci√≥n a protecci√≥n de DD.HH.",
                        "Promoci√≥n activa de DD.HH.",
                        "Iniciativa en ejecuci√≥n de acciones",
                        "Relaciones interpersonales emp√°ticas",
                        "Discreci√≥n en manejo de informaci√≥n",
                        "Principios y Valores institucionales",
                        "Enfoque en grupos vulnerables",
                        "Difusi√≥n de informaci√≥n apropiada"
                    ],
                    puntajeMinimo: 10
                },
                f1: {
                    nombre: "Desempe√±o Profesional Administrativo",
                    requisitos: [
                        "Personal de Nombramiento Supremo de Intendencia/Servicios",
                        "Personal Civil de Nombramiento Supremo/Institucional",
                        "Personal Contratado por Resoluci√≥n (C.P.R.)",
                        "Lista N¬∞1 de M√©ritos o N¬∞2 Satisfactorios",
                        "Sin sanciones administrativas graves"
                    ],
                    factores: [
                        "Eficacia de la labor administrativa",
                        "Eficiencia en uso de recursos",
                        "Calidad del trabajo sin errores importantes",
                        "Capacidad de gesti√≥n seg√∫n planificaci√≥n",
                        "Motivaci√≥n laboral",
                        "Iniciativa en propuesta de soluciones",
                        "Relaciones interpersonales adecuadas",
                        "Discreci√≥n en manejo de informaci√≥n",
                        "Principios y Valores institucionales",
                        "Presentaci√≥n y orden del trabajo"
                    ],
                    puntajeMinimo: 10
                }
            },
            
            // ===== GRADOS CORREGIDOS SEG√öN MANUAL =====
            gradosPorNombramiento: {
                PNS: [
                    "Subteniente", 
                    "Teniente", 
                    "Capit√°n", 
                    "Mayor", 
                    "Teniente Coronel", 
                    "Coronel", 
                    "General"
                ],
                PNI: [
                    "Carabinero", "Cabo 2¬∞", "Cabo 1¬∞", "Sargento 2¬∞", 
                    "Sargento 1¬∞", "Suboficial", "Suboficial Mayor"
                ],
                CPR: [
                    "Profesional", "T√©cnico Superior", "T√©cnico", 
                    "Administrativo", "Especialista", "Analista"
                ]
            },
            
            postulaciones: []
        };
        
        // ===== VARIABLES DE ESTADO =====
        let currentStep = 1;
        let postulacionActual = {
            evaluacion: []
        };
        
        // ===== FUNCIONES DE FORMATO AUTOM√ÅTICO =====
        function formatearRUN(run) {
            if (!run) return '';
            
            // Remover todo excepto n√∫meros y letra K
            let runLimpio = run.replace(/[^0-9kK]/g, '').toUpperCase();
            
            if (runLimpio.length < 2) return runLimpio;
            
            // Si tiene m√°s de 9 caracteres (8 d√≠gitos + DV), truncar
            if (runLimpio.length > 9) {
                runLimpio = runLimpio.substring(0, 9);
            }
            
            // Separar n√∫mero y DV
            let numero = runLimpio.slice(0, -1);
            let dv = runLimpio.slice(-1);
            
            // Formatear n√∫mero con puntos si tiene al menos 7 d√≠gitos
            if (numero.length >= 7) {
                // Insertar puntos cada 3 d√≠gitos desde el final
                let numeroFormateado = '';
                let contador = 0;
                
                for (let i = numero.length - 1; i >= 0; i--) {
                    numeroFormateado = numero[i] + numeroFormateado;
                    contador++;
                    if (contador === 3 && i > 0) {
                        numeroFormateado = '.' + numeroFormateado;
                        contador = 0;
                    }
                }
                
                numero = numeroFormateado;
            }
            
            return numero + '-' + dv;
        }
        
        function formatearRUNCampo(input) {
            const valorOriginal = input.value;
            const cursorPos = input.selectionStart;
            
            // Obtener el nuevo valor formateado
            const valorFormateado = formatearRUN(valorOriginal);
            input.value = valorFormateado;
            
            // Intentar mantener la posici√≥n del cursor
            const cambio = valorFormateado.length - valorOriginal.length;
            input.setSelectionRange(cursorPos + cambio, cursorPos + cambio);
        }
        
        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            inicializarSistema();
            cargarPostulacionesGuardadas();
            configurarEventListeners();
            verificarConexionSheets();
        });
        
        function inicializarSistema() {
            cargarGrados();
            configurarCategoriaListener();
            configurarNombramientoListener();
        }
        
        function cargarPostulacionesGuardadas() {
            try {
                const guardadas = localStorage.getItem('postulacionesCarabinerosOG3125');
                if (guardadas) {
                    sistema.postulaciones = JSON.parse(guardadas);
                    console.log(`Cargadas ${sistema.postulaciones.length} postulaciones previas`);
                }
            } catch (error) {
                console.error('Error cargando postulaciones:', error);
                sistema.postulaciones = [];
            }
        }
        
        // ===== VERIFICAR CONEXI√ìN CON GOOGLE SHEETS =====
        async function verificarConexionSheets() {
            try {
                document.getElementById('valSheets').innerHTML = '<span class="spinner"></span>Verificando conexi√≥n...';
                
                const response = await fetch(GOOGLE_SHEETS_WEB_APP_URL);
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('valSheets').innerHTML = '‚úÖ Conexi√≥n con Google Sheets establecida';
                    document.getElementById('valSheets').style.color = 'var(--verde-ok)';
                    return true;
                } else {
                    throw new Error('Error en la conexi√≥n');
                }
            } catch (error) {
                console.warn('No se pudo verificar conexi√≥n con Google Sheets:', error);
                document.getElementById('valSheets').innerHTML = '‚ö†Ô∏è Conexi√≥n con Google Sheets no disponible';
                document.getElementById('valSheets').style.color = 'var(--amarillo-alerta)';
                return false;
            }
        }
        
        // ===== CONFIGURACI√ìN DE EVENT LISTENERS =====
        function configurarEventListeners() {
            // Evento para mostrar requisitos al seleccionar categor√≠a
            document.getElementById('categoriaPremio').addEventListener('change', function() {
                mostrarRequisitosCategoria(this.value);
            });
            
            // Evento para actualizar grados al cambiar nombramiento
            document.getElementById('nombramiento').addEventListener('change', function() {
                actualizarGradosPorNombramiento(this.value);
            });
            
            // Evento para validar RUN en tiempo real
            document.getElementById('run').addEventListener('blur', validarRUNCampo);
        }
        
        function configurarCategoriaListener() {
            const select = document.getElementById('categoriaPremio');
            select.addEventListener('change', function() {
                const categoria = this.value;
                const requisitosDiv = document.getElementById('requisitosCategoria');
                const lista = document.getElementById('listaRequisitos');
                
                if (categoria && sistema.categorias[categoria]) {
                    requisitosDiv.classList.remove('hidden');
                    lista.innerHTML = '';
                    
                    sistema.categorias[categoria].requisitos.forEach(req => {
                        const li = document.createElement('li');
                        li.textContent = req;
                        lista.appendChild(li);
                    });
                } else {
                    requisitosDiv.classList.add('hidden');
                }
            });
        }
        
        function configurarNombramientoListener() {
            document.getElementById('nombramiento').addEventListener('change', function() {
                const nombramiento = this.value;
                const selectGrado = document.getElementById('grado');
                
                selectGrado.disabled = !nombramiento;
                
                if (nombramiento) {
                    const grados = sistema.gradosPorNombramiento[nombramiento] || [];
                    selectGrado.innerHTML = '<option value="">-- Seleccione grado --</option>';
                    
                    grados.forEach(grado => {
                        const option = document.createElement('option');
                        option.value = grado;
                        option.textContent = grado;
                        selectGrado.appendChild(option);
                    });
                } else {
                    selectGrado.innerHTML = '<option value="">-- Seleccione nombramiento primero --</option>';
                }
            });
        }
        
        // ===== FUNCIONES DE CARGA =====
        function cargarGrados() {
            const select = document.getElementById('grado');
            select.innerHTML = '<option value="">-- Seleccione nombramiento primero --</option>';
        }
        
        function actualizarGradosPorNombramiento(nombramiento) {
            const select = document.getElementById('grado');
            select.disabled = !nombramiento;
            
            if (nombramiento) {
                const grados = sistema.gradosPorNombramiento[nombramiento] || [];
                select.innerHTML = '<option value="">-- Seleccione grado --</option>';
                
                grados.forEach(grado => {
                    const option = document.createElement('option');
                    option.value = grado;
                    option.textContent = grado;
                    select.appendChild(option);
                });
            }
        }
        
        function mostrarRequisitosCategoria(categoria) {
            const requisitosDiv = document.getElementById('requisitosCategoria');
            const lista = document.getElementById('listaRequisitos');
            
            if (categoria && sistema.categorias[categoria]) {
                requisitosDiv.classList.remove('hidden');
                lista.innerHTML = '';
                
                sistema.categorias[categoria].requisitos.forEach(req => {
                    const li = document.createElement('li');
                    li.textContent = req;
                    lista.appendChild(li);
                });
            } else {
                requisitosDiv.classList.add('hidden');
            }
        }
        
        // ===== NAVEGACI√ìN ENTRE PASOS (CORREGIDA) =====
        function nextStep(step) {
            if (!validarPaso(currentStep)) {
                mostrarAlerta('error', 'Por favor complete todos los campos requeridos correctamente');
                return;
            }
            
            // Ocultar paso actual
            document.getElementById(`stepContent${currentStep}`).classList.remove('active');
            
            // Marcar paso como completado
            document.getElementById(`step${currentStep}`).classList.add('completed');
            
            // Actualizar estado
            currentStep = step;
            
            // Mostrar nuevo paso
            document.getElementById(`stepContent${currentStep}`).classList.add('active');
            
            // Actualizar progreso visual (CORRECCI√ìN APLICADA)
            actualizarProgreso();
            
            // Configuraci√≥n espec√≠fica por paso
            switch(step) {
                case 4:
                    cargarFactoresEvaluacion();
                    break;
                case 5:
                    generarResumen();
                    break;
            }
        }
        
        function prevStep(step) {
            // Ocultar paso actual
            document.getElementById(`stepContent${currentStep}`).classList.remove('active');
            
            // Quitar estado completado del paso actual
            document.getElementById(`step${currentStep}`).classList.remove('completed');
            
            // Actualizar estado
            currentStep = step;
            
            // Mostrar paso anterior
            document.getElementById(`stepContent${currentStep}`).classList.add('active');
            
            // Actualizar progreso visual
            actualizarProgreso();
        }
        
        // ===== FUNCI√ìN DE PROGRESO CORREGIDA =====
        function actualizarProgreso() {
            document.querySelectorAll('.step').forEach((step, i) => {
                const stepNumber = i + 1;
                
                // Solo el paso actual tiene clase 'active'
                if (stepNumber === currentStep) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else if (stepNumber < currentStep) {
                    step.classList.remove('active');
                    step.classList.add('completed');
                } else {
                    step.classList.remove('active');
                    step.classList.remove('completed');
                }
            });
        }
        
        // ===== VALIDACIONES (CORREGIDAS) =====
        function validarPaso(paso) {
            let valido = true;
            
            switch(paso) {
                case 1:
                    valido = validarPaso1();
                    break;
                    
                case 2:
                    valido = validarPaso2();
                    break;
                    
                case 3:
                    valido = validarPaso3();
                    break;
                    
                case 4:
                    valido = validarPaso4();
                    break;
                    
                case 5:
                    valido = validarPaso5();
                    break;
            }
            
            return valido;
        }
        
        function validarPaso1() {
            const categoria = document.getElementById('categoriaPremio').value;
            let valido = true;
            
            if (!categoria) {
                mostrarError('categoriaError');
                valido = false;
            } else {
                ocultarError('categoriaError');
                postulacionActual.categoria = categoria;
                postulacionActual.categoriaNombre = sistema.categorias[categoria].nombre;
            }
            
            return valido;
        }
        
        function validarPaso2() {
            let valido = true;
            
            // Limpiar errores previos
            ocultarError('runError');
            ocultarError('nombresError');
            ocultarError('apellidosError');
            ocultarError('nombramientoError');
            ocultarError('gradoError');
            ocultarError('altaRepError');
            ocultarError('reparticionError');
            ocultarError('dotacionError');
            
            // Validar RUN (CON FORMATO AUTOM√ÅTICO)
            const runInput = document.getElementById('run');
            let run = runInput.value;
            
            // Asegurarse de que el RUN est√© formateado
            if (run) {
                run = formatearRUN(run);
                runInput.value = run; // Actualizar campo con formato
            }
            
            if (!validarRUN(run)) {
                mostrarError('runError');
                valido = false;
            } else {
                postulacionActual.run = run;
            }
            
            // Validar campos con mapeo CORREGIDO
            const campos = [
                { id: 'nombres', error: 'nombresError' },
                { id: 'apellidos', error: 'apellidosError' },
                { id: 'nombramiento', error: 'nombramientoError' },
                { id: 'grado', error: 'gradoError' },
                { id: 'altaReparticion', error: 'altaRepError' },
                { id: 'reparticion', error: 'reparticionError' },
                { id: 'dotacion', error: 'dotacionError' }
            ];
            
            campos.forEach(campo => {
                const el = document.getElementById(campo.id);
                if (!el.value) {
                    mostrarError(campo.error);
                    valido = false;
                } else {
                    ocultarError(campo.error);
                    postulacionActual[campo.id] = el.value;
                }
            });
            
            return valido;
        }
        
        function validarPaso3() {
            let valido = true;
            
            // Limpiar errores previos
            ocultarError('listaError');
            ocultarError('sancionesError');
            ocultarError('procesoError');
            
            const campos = [
                { id: 'listaMeritos', error: 'listaError' },
                { id: 'sanciones12meses', error: 'sancionesError' },
                { id: 'procesoJudicial', error: 'procesoError' }
            ];
            
            campos.forEach(campo => {
                const el = document.getElementById(campo.id);
                if (!el.value) {
                    mostrarError(campo.error);
                    valido = false;
                } else {
                    ocultarError(campo.error);
                    postulacionActual[campo.id] = el.value;
                }
            });
            
            // Validar elegibilidad
            if (!validarElegibilidad()) {
                valido = false;
            }
            
            // Guardar otros antecedentes
            postulacionActual.amonestaciones = document.getElementById('amonestaciones').value;
            postulacionActual.reprensiones = document.getElementById('reprensiones').value;
            postulacionActual.arrestos = document.getElementById('arrestos').value;
            postulacionActual.licenciaActo = document.getElementById('licenciaActo').value;
            
            return valido;
        }
        
        function validarPaso4() {
            const categoriaActual = postulacionActual.categoria;
            let valido = true;
            let totalPuntaje = 0;
            
            // Limpiar evaluaci√≥n previa
            postulacionActual.evaluacion = [];
            
            // Validar factores
            const factores = document.querySelectorAll('.factor-input');
            factores.forEach((input, index) => {
                const valor = parseInt(input.value) || 0;
                
                if (valor < 1 || valor > 3) {
                    mostrarError(`factor${index}Error`);
                    valido = false;
                } else {
                    ocultarError(`factor${index}Error`);
                    totalPuntaje += valor;
                    
                    // Guardar factor con justificaci√≥n si aplica
                    const justificacion = document.getElementById(`justificacion${index}`)?.value || '';
                    
                    postulacionActual.evaluacion.push({
                        factor: sistema.categorias[categoriaActual].factores[index],
                        puntaje: valor,
                        justificacion: valor === 3 ? justificacion : ''
                    });
                    
                    // Validar justificaci√≥n obligatoria para puntaje 3
                    if (valor === 3 && !justificacion.trim()) {
                        mostrarError(`justificacion${index}Error`);
                        valido = false;
                    } else {
                        ocultarError(`justificacion${index}Error`);
                    }
                }
            });
            
            // Validar secci√≥n especial para acci√≥n policial
            if (categoriaActual === 'd3') {
                const narracion = document.getElementById('narracionHecho').value;
                const razones = document.getElementById('razonesFundamentacion').value;
                
                if (!narracion.trim()) {
                    mostrarError('narracionError');
                    valido = false;
                } else {
                    ocultarError('narracionError');
                    postulacionActual.narracionHecho = narracion;
                }
                
                if (!razones.trim()) {
                    mostrarError('razonesError');
                    valido = false;
                } else {
                    ocultarError('razonesError');
                    postulacionActual.razonesFundamentacion = razones;
                }
            }
            
            // Guardar puntaje total
            postulacionActual.totalPuntaje = totalPuntaje;
            document.getElementById('totalPuntaje').value = totalPuntaje;
            
            return valido;
        }
        
        function validarPaso5() {
            const declaracion = document.getElementById('declaracionVeracidad').checked;
            let valido = true;
            
            if (!declaracion) {
                mostrarError('declaracionError');
                valido = false;
            } else {
                ocultarError('declaracionError');
                postulacionActual.declaracionVeracidad = true;
            }
            
            return valido;
        }
        
        // ===== VALIDACI√ìN RUN CORREGIDA =====
        function validarRUN(run) {
            if (!run) return false;
            
            // Asegurar formato correcto antes de validar
            run = formatearRUN(run);
            
            // Validar formato b√°sico
            const regex = /^[0-9]{1,3}(?:\.[0-9]{3}){2}-[0-9K]$/;
            if (!regex.test(run)) return false;
            
            // Extraer n√∫mero y d√≠gito verificador
            const [numConPuntos, dvIngresado] = run.split('-');
            const num = numConPuntos.replace(/\./g, '');
            
            // Verificar longitud del n√∫mero
            if (num.length < 7 || num.length > 8) return false;
            
            let suma = 0;
            let multiplo = 2;
            
            // Calcular d√≠gito verificador
            for (let i = num.length - 1; i >= 0; i--) {
                suma += parseInt(num[i]) * multiplo;
                multiplo = multiplo === 7 ? 2 : multiplo + 1;
            }
            
            const dv = 11 - (suma % 11);
            let dvFinal = dv === 11 ? '0' : dv === 10 ? 'K' : dv.toString();
            
            return dvFinal === dvIngresado;
        }
        
        function validarRUNCampo() {
            const runInput = document.getElementById('run');
            let runValue = runInput.value;
            
            if (!runValue) return;
            
            // Aplicar formato autom√°tico
            runValue = formatearRUN(runValue);
            runInput.value = runValue;
            
            if (validarRUN(runValue)) {
                runInput.classList.remove('error');
                runInput.classList.add('success');
                ocultarError('runError');
            } else {
                runInput.classList.remove('success');
                runInput.classList.add('error');
                mostrarError('runError');
            }
        }
        
        // ===== VALIDACI√ìN DE ELEGIBILIDAD =====
        function validarElegibilidad() {
            const sanciones = document.getElementById('sanciones12meses')?.value;
            const proceso = document.getElementById('procesoJudicial')?.value;
            
            let elegible = true;
            let mensaje = '';
            
            if (sanciones === 'si') {
                elegible = false;
                mensaje += '‚Ä¢ Tiene sanciones (d√≠as de arresto) en los √∫ltimos 12 meses\n';
            }
            
            if (proceso === 'si_imputado') {
                elegible = false;
                mensaje += '‚Ä¢ Est√° sometido a proceso judicial como formalizado/imputado\n';
            }
            
            if (!elegible) {
                mostrarAlerta('error', 
                    '‚ö†Ô∏è NO ELEGIBLE SEG√öN ART. 8.7 OG 3125\n\n' + 
                    mensaje + 
                    '\nEl funcionario no cumple los requisitos de elegibilidad establecidos en el Manual.'
                );
            }
            
            return elegible;
        }
        
        // ===== FUNCIONES DE ERROR CORREGIDAS =====
        function mostrarError(id) {
            const errorEl = document.getElementById(id);
            const inputId = id.replace('Error', '');
            const inputEl = document.getElementById(inputId);
            
            if (errorEl) {
                errorEl.classList.add('show');
            }
            
            if (inputEl) {
                inputEl.classList.add('error');
                inputEl.classList.remove('success');
            }
        }
        
        function ocultarError(id) {
            const errorEl = document.getElementById(id);
            const inputId = id.replace('Error', '');
            const inputEl = document.getElementById(inputId);
            
            if (errorEl) {
                errorEl.classList.remove('show');
            }
            
            if (inputEl) {
                inputEl.classList.remove('error');
            }
        }
        
        // ===== FUNCI√ìN PARA CARGAR FACTORES =====
        function cargarFactoresEvaluacion() {
            const categoria = postulacionActual.categoria;
            const factoresDiv = document.getElementById('factoresEvaluacion');
            const titulo = document.getElementById('categoriaTitulo');
            
            if (!categoria) return;
            
            const categoriaInfo = sistema.categorias[categoria];
            titulo.textContent = categoriaInfo.nombre;
            
            factoresDiv.innerHTML = '';
            
            categoriaInfo.factores.forEach((factor, index) => {
                const factorDiv = document.createElement('div');
                factorDiv.className = 'form-group';
                factorDiv.innerHTML = `
                    <label>${index + 1}. ${factor} <span class="required">*</span></label>
                    <select class="form-control factor-input" id="factor${index}" 
                            onchange="actualizarTotalPuntaje(); toggleJustificacion(${index})">
                        <option value="0">-- Seleccione puntaje --</option>
                        <option value="1">1 - Bueno</option>
                        <option value="2">2 - Muy Bueno</option>
                        <option value="3">3 - Excelente</option>
                    </select>
                    <div class="error-message" id="factor${index}Error">Seleccione un puntaje</div>
                    <div id="justificacion${index}Div" class="hidden" style="margin-top: 10px;">
                        <label>Justificaci√≥n del puntaje excelente (requerida):</label>
                        <textarea class="form-control" id="justificacion${index}" rows="3" 
                                  placeholder="Explique por qu√© merece el puntaje m√°ximo en este factor..."></textarea>
                        <div class="error-message" id="justificacion${index}Error">Debe justificar el puntaje excelente</div>
                    </div>
                `;
                factoresDiv.appendChild(factorDiv);
            });
            
            // Mostrar/ocultar secci√≥n especial para acci√≥n policial
            const seccionAccion = document.getElementById('seccionAccionPolicial');
            if (categoria === 'd3') {
                seccionAccion.classList.remove('hidden');
            } else {
                seccionAccion.classList.add('hidden');
            }
            
            // Inicializar total
            actualizarTotalPuntaje();
        }
        
        function toggleJustificacion(index) {
            const select = document.getElementById(`factor${index}`);
            const justificacionDiv = document.getElementById(`justificacion${index}Div`);
            
            if (select.value === '3') {
                justificacionDiv.classList.remove('hidden');
            } else {
                justificacionDiv.classList.add('hidden');
                document.getElementById(`justificacion${index}Error`).classList.remove('show');
            }
        }
        
        function actualizarTotalPuntaje() {
            const factores = document.querySelectorAll('.factor-input');
            let total = 0;
            
            factores.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            
            document.getElementById('totalPuntaje').value = total;
        }
        
        // ===== GENERAR RESUMEN FINAL =====
        function generarResumen() {
            const resumenDiv = document.getElementById('resumenPostulacion');
            const alertDiv = document.getElementById('revisionAlert');
            
            // Validar elegibilidad final
            let elegible = true;
            let mensajesError = [];
            let mensajesOk = [];
            
            // 1. Validar categor√≠a
            if (!postulacionActual.categoria) {
                elegible = false;
                mensajesError.push('‚ùå No se seleccion√≥ categor√≠a');
                document.getElementById('valCategoria').innerHTML = '‚ùå Categor√≠a no seleccionada';
                document.getElementById('valCategoria').style.color = 'var(--rojo-error)';
            } else {
                mensajesOk.push('‚úÖ Categor√≠a seleccionada correctamente');
                document.getElementById('valCategoria').innerHTML = '‚úì Categor√≠a seleccionada correctamente';
                document.getElementById('valCategoria').style.color = 'var(--verde-ok)';
            }
            
            // 2. Validar datos personales
            if (!postulacionActual.run || !postulacionActual.nombres || !postulacionActual.apellidos) {
                elegible = false;
                mensajesError.push('‚ùå Datos personales incompletos');
                document.getElementById('valDatos').innerHTML = '‚ùå Datos personales incompletos';
                document.getElementById('valDatos').style.color = 'var(--rojo-error)';
            } else {
                mensajesOk.push('‚úÖ Datos personales completos y v√°lidos');
                document.getElementById('valDatos').innerHTML = '‚úì Datos personales completos y v√°lidos';
                document.getElementById('valDatos').style.color = 'var(--verde-ok)';
            }
            
            // 3. Validar antecedentes
            if (!postulacionActual.listaMeritos || !postulacionActual.sanciones12meses || !postulacionActual.procesoJudicial) {
                elegible = false;
                mensajesError.push('‚ùå Antecedentes incompletos');
                document.getElementById('valAntecedentes').innerHTML = '‚ùå Antecedentes incompletos';
                document.getElementById('valAntecedentes').style.color = 'var(--rojo-error)';
            } else if (postulacionActual.sanciones12meses === 'si' || postulacionActual.procesoJudicial === 'si_imputado') {
                elegible = false;
                mensajesError.push('‚ùå No cumple requisitos de elegibilidad (Art. 8.7)');
                document.getElementById('valAntecedentes').innerHTML = '‚ùå No cumple requisitos Art. 8.7';
                document.getElementById('valAntecedentes').style.color = 'var(--rojo-error)';
            } else {
                mensajesOk.push('‚úÖ Antecedentes validados seg√∫n Art. 8.7');
                document.getElementById('valAntecedentes').innerHTML = '‚úì Antecedentes validados seg√∫n Art. 8.7';
                document.getElementById('valAntecedentes').style.color = 'var(--verde-ok)';
            }
            
            // 4. Validar evaluaci√≥n
            if (!postulacionActual.evaluacion || postulacionActual.evaluacion.length === 0) {
                elegible = false;
                mensajesError.push('‚ùå Evaluaci√≥n incompleta');
                document.getElementById('valEvaluacion').innerHTML = '‚ùå Evaluaci√≥n incompleta';
                document.getElementById('valEvaluacion').style.color = 'var(--rojo-error)';
            } else {
                const categoria = postulacionActual.categoria;
                const puntajeMinimo = sistema.categorias[categoria]?.puntajeMinimo || 10;
                
                if (postulacionActual.totalPuntaje < puntajeMinimo) {
                    elegible = false;
                    mensajesError.push(`‚ùå Puntaje insuficiente (m√≠nimo ${puntajeMinimo} puntos)`);
                    document.getElementById('valEvaluacion').innerHTML = `‚ùå Puntaje insuficiente (${postulacionActual.totalPuntaje}/${puntajeMinimo})`;
                    document.getElementById('valEvaluacion').style.color = 'var(--rojo-error)';
                } else {
                    mensajesOk.push(`‚úÖ Evaluaci√≥n completa (${postulacionActual.totalPuntaje} puntos)`);
                    document.getElementById('valEvaluacion').innerHTML = `‚úì Evaluaci√≥n completa (${postulacionActual.totalPuntaje} puntos)`;
                    document.getElementById('valEvaluacion').style.color = 'var(--verde-ok)';
                }
            }
            
            // 5. Validar elegibilidad final
            document.getElementById('valElegibilidad').innerHTML = elegible ? 
                '‚úì Cumple requisitos de elegibilidad' : '‚ùå No cumple requisitos de elegibilidad';
            document.getElementById('valElegibilidad').style.color = elegible ? 'var(--verde-ok)' : 'var(--rojo-error)';
            
            // 6. Validar conexi√≥n Sheets
            document.getElementById('valSheets').innerHTML = '‚úÖ Conexi√≥n con Google Sheets disponible';
            document.getElementById('valSheets').style.color = 'var(--verde-ok)';
            
            // Configurar alerta
            if (elegible) {
                alertDiv.className = 'alert alert-success show';
                alertDiv.innerHTML = `
                    <strong>‚úÖ POSTULACI√ìN V√ÅLIDA</strong><br>
                    Cumple con todos los requisitos de la Orden General N¬∞ 3125<br>
                    <small>Los datos se enviar√°n autom√°ticamente a Google Sheets</small>
                `;
            } else {
                alertDiv.className = 'alert alert-danger show';
                alertDiv.innerHTML = `
                    <strong>‚ùå POSTULACI√ìN NO V√ÅLIDA</strong><br>
                    No cumple con los requisitos:<br>
                    ${mensajesError.map(m => `<div style="margin-left: 20px;">${m}</div>`).join('')}
                `;
            }
            
            // Activar/desactivar bot√≥n enviar (CORRECCI√ìN APLICADA)
            document.getElementById('btnEnviar').disabled = !elegible;
            
            // Generar tabla de resumen
            let html = `
                <div class="table-container">
                    <table>
                        <tr>
                            <th colspan="2" style="background: var(--azul-carabineros); color: white;">
                                RESUMEN DE POSTULACI√ìN
                            </th>
                        </tr>
                        <tr>
                            <td style="width: 30%;"><strong>Categor√≠a</strong></td>
                            <td>${postulacionActual.categoriaNombre || 'No definida'}</td>
                        </tr>
                        <tr>
                            <td><strong>Funcionario</strong></td>
                            <td>
                                ${postulacionActual.nombres || ''} ${postulacionActual.apellidos || ''}<br>
                                <small>RUN: ${postulacionActual.run || 'No ingresado'} | 
                                Grado: ${postulacionActual.grado || 'No ingresado'}</small>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Unidad</strong></td>
                            <td>
                                ${postulacionActual.altaReparticion || ''} > 
                                ${postulacionActual.reparticion || ''}<br>
                                <small>Dotaci√≥n: ${postulacionActual.dotacion || ''}</small>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Antecedentes</strong></td>
                            <td>
                                Lista: ${postulacionActual.listaMeritos === 'lista1' ? 'N¬∞1 M√©ritos' : 
                                       postulacionActual.listaMeritos === 'lista2' ? 'N¬∞2 Satisfactorios' : 'No especificada'}<br>
                                Sanciones 12 meses: ${postulacionActual.sanciones12meses === 'si' ? 'S√ç ‚ö†Ô∏è' : 'NO ‚úÖ'}<br>
                                Proceso judicial: ${postulacionActual.procesoJudicial ? 
                                    postulacionActual.procesoJudicial.replace('si_imputado', 'S√ç (imputado) ‚ö†Ô∏è')
                                               .replace('si_victima', 'S√≠ (v√≠ctima)')
                                               .replace('no', 'NO ‚úÖ') : 'No especificado'}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Evaluaci√≥n</strong></td>
                            <td>
                                Total Puntaje: <strong>${postulacionActual.totalPuntaje || 0}</strong><br>
                                Factores evaluados: ${postulacionActual.evaluacion?.length || 0}<br>
                                <small style="color: ${postulacionActual.totalPuntaje >= (sistema.categorias[postulacionActual.categoria]?.puntajeMinimo || 10) ? 'green' : 'red'}">
                                    ${postulacionActual.totalPuntaje >= (sistema.categorias[postulacionActual.categoria]?.puntajeMinimo || 10) ? 
                                      '‚úÖ Cumple puntaje m√≠nimo' : '‚ùå No cumple puntaje m√≠nimo'}
                                </small>
                            </td>
                        </tr>
                        ${postulacionActual.narracionHecho ? `
                        <tr>
                            <td><strong>Narraci√≥n</strong></td>
                            <td><em>"${postulacionActual.narracionHecho.substring(0, 100)}..."</em></td>
                        </tr>
                        ` : ''}
                        <tr>
                            <td><strong>Google Sheets</strong></td>
                            <td>
                                <span class="status-badge status-complete">ENV√çO AUTOM√ÅTICO</span><br>
                                <small>Los datos se enviar√°n autom√°ticamente al formulario</small>
                            </td>
                        </tr>
                    </table>
                </div>
            `;
            
            resumenDiv.innerHTML = html;
        }
        
        // ===== INTEGRACI√ìN CON GOOGLE SHEETS =====
        async function enviarPostulacion() {
            if (!validarPaso(5)) {
                mostrarAlerta('error', 'Debe aceptar la declaraci√≥n de veracidad');
                return;
            }
            
            // Cambiar texto del bot√≥n a "Enviando..."
            const btnEnviar = document.getElementById('btnEnviar');
            const originalText = btnEnviar.innerHTML;
            btnEnviar.innerHTML = '<span class="spinner"></span> Enviando a Google Sheets...';
            btnEnviar.disabled = true;
            
            // Generar ID √∫nico
            const timestamp = new Date().getTime();
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            const postulacionId = `POST-${timestamp.toString().slice(-6)}-${random}`;
            
            // Completar objeto de postulaci√≥n
            postulacionActual.id = postulacionId;
            postulacionActual.fechaEnvio = new Date().toLocaleString('es-CL', {
                timeZone: 'America/Santiago'
            });
            postulacionActual.estado = 'COMPLETA CONFORME OG 3125';
            postulacionActual.version = '1.0';
            
            // Preparar datos para Google Sheets - CORREGIDO para formato correcto
            const datosParaSheet = [
                postulacionActual.id,
                postulacionActual.fechaEnvio,
                postulacionActual.estado,
                postulacionActual.categoria,
                postulacionActual.categoriaNombre,
                postulacionActual.run,
                postulacionActual.nombres,
                postulacionActual.apellidos,
                postulacionActual.nombramiento,
                postulacionActual.grado,
                postulacionActual.altaReparticion,
                postulacionActual.reparticion,
                postulacionActual.dotacion,
                postulacionActual.listaMeritos,
                postulacionActual.sanciones12meses,
                postulacionActual.procesoJudicial,
                postulacionActual.amonestaciones || 0,
                postulacionActual.reprensiones || 0,
                postulacionActual.arrestos || 0,
                postulacionActual.licenciaActo || 0,
                postulacionActual.totalPuntaje || 0,
                JSON.stringify(postulacionActual.evaluacion || []),
                postulacionActual.narracionHecho || '',
                postulacionActual.razonesFundamentacion || '',
                postulacionActual.declaracionVeracidad ? 'S√ç' : 'NO'
            ];
            
            try {
                // Enviar a Google Sheets - CORREGIDO para evitar problemas de CORS
                mostrarAlerta('info', 'Enviando datos a Google Sheets...');
                
                // Crear FormData para env√≠o correcto
                const formData = new FormData();
                formData.append('action', 'insertarPostulacion');
                formData.append('datos', JSON.stringify(datosParaSheet));
                formData.append('timestamp', new Date().toISOString());
                
                // Usar fetch sin 'no-cors' para poder verificar respuesta
                const response = await fetch(GOOGLE_SHEETS_WEB_APP_URL, {
                    method: 'POST',
                    body: formData
                });
                
                // Verificar si la respuesta es OK
                if (response.ok) {
                    const result = await response.text();
                    console.log('Respuesta Google Sheets:', result);
                    
                    // Guardar localmente como respaldo
                    sistema.postulaciones.push(JSON.parse(JSON.stringify(postulacionActual)));
                    localStorage.setItem('postulacionesCarabinerosOG3125', JSON.stringify(sistema.postulaciones));
                    
                    // Mostrar confirmaci√≥n exitosa
                    mostrarConfirmacionExito(postulacionId);
                } else {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error enviando a Google Sheets:', error);
                
                // Guardar localmente aunque falle el env√≠o a Sheets
                sistema.postulaciones.push(JSON.parse(JSON.stringify(postulacionActual)));
                localStorage.setItem('postulacionesCarabinerosOG3125', JSON.stringify(sistema.postulaciones));
                
                // Mostrar advertencia pero permitir continuar
                mostrarAlerta('warning', 
                    '‚ö†Ô∏è Los datos se guardaron localmente pero hubo un problema con Google Sheets.<br>' +
                    'Puede continuar o intentar exportar manualmente m√°s tarde.'
                );
                
                // Mostrar confirmaci√≥n parcial
                mostrarConfirmacionParcial(postulacionId);
            } finally {
                // Restaurar bot√≥n
                btnEnviar.innerHTML = originalText;
                btnEnviar.disabled = false;
            }
        }
        
        function mostrarConfirmacionExito(postulacionId) {
            document.getElementById('postulacionId').textContent = postulacionId;
            document.getElementById('postulacionFecha').textContent = postulacionActual.fechaEnvio;
            document.getElementById('sheetsStatus').textContent = 'REGISTRADO EN SHEETS';
            document.getElementById('confirmModal').classList.add('active');
            
            // Log de auditor√≠a
            console.log(`Postulaci√≥n ${postulacionId} enviada exitosamente a Google Sheets`);
        }
        
        function mostrarConfirmacionParcial(postulacionId) {
            document.getElementById('postulacionId').textContent = postulacionId;
            document.getElementById('postulacionFecha').textContent = postulacionActual.fechaEnvio;
            document.getElementById('sheetsStatus').textContent = 'SOLO LOCAL';
            document.getElementById('sheetsStatus').className = 'status-badge status-pending';
            document.getElementById('confirmModal').classList.add('active');
            
            // Agregar mensaje adicional
            const modalContent = document.querySelector('.modal-content');
            const existingMsg = modalContent.querySelector('#sheetsWarning');
            if (!existingMsg) {
                const warningMsg = document.createElement('div');
                warningMsg.id = 'sheetsWarning';
                warningMsg.className = 'alert alert-warning';
                warningMsg.style.margin = '10px 0';
                warningMsg.innerHTML = `
                    <strong>‚ö†Ô∏è Atenci√≥n:</strong> Los datos se guardaron localmente pero no se pudieron enviar a Google Sheets.<br>
                    <small>Puede exportar los datos manualmente m√°s tarde usando la funci√≥n de exportaci√≥n.</small>
                `;
                modalContent.insertBefore(warningMsg, modalContent.querySelector('p:last-of-type'));
            }
        }
        
        function nuevaPostulacion() {
            // Reiniciar formulario
            document.querySelectorAll('input, select, textarea').forEach(element => {
                if (element.type !== 'button' && element.type !== 'submit') {
                    element.value = '';
                    element.classList.remove('error', 'success');
                    
                    if (element.type === 'checkbox') {
                        element.checked = false;
                    }
                }
            });
            
            // Reiniciar errores
            document.querySelectorAll('.error-message').forEach(el => {
                el.classList.remove('show');
            });
            
            // Reiniciar estado
            currentStep = 1;
            postulacionActual = { evaluacion: [] };
            
            // Reiniciar interfaz
            document.querySelectorAll('.step-content').forEach(div => {
                div.classList.remove('active');
            });
            document.getElementById('stepContent1').classList.add('active');
            
            // Reiniciar progreso
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index === 0) {
                    step.classList.add('active');
                }
            });
            
            // Ocultar alertas
            document.getElementById('globalAlert').classList.remove('show');
            document.getElementById('revisionAlert').classList.remove('show');
            
            // Habilitar bot√≥n enviar
            document.getElementById('btnEnviar').disabled = false;
            
            // Reiniciar grados
            cargarGrados();
            
            closeModal();
            
            mostrarAlerta('success', 'Nueva postulaci√≥n iniciada. Complete los datos desde el principio.');
        }
        
        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }
        
        // ===== FUNCIONES AUXILIARES =====
        function mostrarAlerta(tipo, mensaje) {
            const alertDiv = document.getElementById('globalAlert');
            
            alertDiv.className = `alert alert-${tipo} show`;
            alertDiv.innerHTML = mensaje;
            
            // Auto-ocultar despu√©s de 5 segundos
            setTimeout(() => {
                alertDiv.classList.remove('show');
            }, 5000);
        }
        
        // ===== EXPORTAR DATOS A JSON (OPCIONAL) =====
        function exportarPostulaciones() {
            if (sistema.postulaciones.length === 0) {
                mostrarAlerta('warning', 'No hay postulaciones para exportar');
                return;
            }
            
            const dataStr = JSON.stringify(sistema.postulaciones, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `postulaciones_carabineros_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // ===== VISUALIZAR GOOGLE SHEETS =====
        function verGoogleSheets() {
            window.open(GOOGLE_SHEET_URL, '_blank');
        }
    </script>
</body>
</html>
